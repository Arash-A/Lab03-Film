<!DOCTYPE html>
<html lang="fr">
	<head>
		<title>Film Pour Tous</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
		<link rel="stylesheet" type="text/css" href="css/bootstrapValidator.css">
		<link rel="stylesheet" type="text/css" href="css/films.css">
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/bootstrap.js"></script>
		<script src="js/jquery.validate.js"></script>
		<script src="js/film.js"></script>
		<script src="js/mustache.js"></script>
		<link rel="stylesheet" type="text/css" href="css/style.css">
	</head>
	<body>
		<div id="container" class="container"> 
			<nav id="nav" class="navbar navbar-default">
				<div class="container-fluid">
					<div class="navbar-header">
						<a class="navbar-brand" href="index.html"><span class="glyphicon glyphicon-film" ></span></a>
					</div>
										
					<div class="collapse navbar-collapse" id="myNavbar">
						<ul class="nav navbar-nav navbar-right">
							<li><button type="button" class="navbtn" id="myBtn1"><span class="glyphicon glyphicon-shopping-cart"></span>Panier</li>
							<!--li><a href="connexion.html" id="myBtn1"><span class="glyphicon glyphicon-log-in" ></span> Connexion</a></li-->
							<li><button type="button" class="navbtn" id="connexionBtn"><span class="glyphicon glyphicon-log-in" ></span> Connexion</li>
						</ul>						
						<form action="" class="navbar-form ">
							<div class="input-group col-md-4 pull-right">
								<input type="text" class="form-control" placeholder="Search Film..">
								<span class="input-group-btn">
								  <button class="btn btn-default" type="button">
									<span class="glyphicon glyphicon-search"></span>
								  </button>
								</span>
							</div>
						</form>								
					</div>											
				</div>
			</nav>
			
			<div id="menu" class="col-md-2 show">
				<h4>Catégorie</h4>
				  <ul id="categorieMenu" class="nav nav-pills nav-stacked">
				  </ul>
	        </div>
			
			<div id="gestion" class="col-md-2 hide">
				<h4>Gestion</h4>
				  <ul class="nav nav-pills nav-stacked">
					<li id="liGestionFilm" class="active"><a class="menuGestionFilm" href="#">Gestion de film</a></li>
					<li id="liGestionMembre"><a class="menuGestionMembre" href="#">Gestion de membre</a></li>
				  </ul>
	        </div>
			
	        <div id="main" class="col-md-10 show">
				<div class="hide" id="templateCard">
						<div class="col-md-3 text-center" >
							<div class="card" style="width: 18rem;">
									<a href="images/1.jpe" target="_blank">
										<img class="card-img-top" src="images/{{pochette}}" alt="Card image cap" style="width:55%">
									</a>							
								<h5 class="card-title">
									<a href="images/1.jpe" target="_blank">
										<p class="card-text">{{titre}}</p>
									</a>
								</h5>							
								<div class="card-body">
									<p class="card-text">{{realisateru}}</p>
									<p class="card-text">{{prix}}</p>
									<a href="#" class="btn btn-primary">Panier</a>
								</div>							
							</div>
						</div>
					</div>
	            <div class="well" id="films"></div>
	        </div>
			
			<div class="hide" id="login"> 
				<form id="loginF">
					<fieldset>
							<legend>CONNEXION</legend>
				  <div class="form-group">
					<label for="courrielLogin">Courriel</label>
					<input type="email" class="form-control" id="courrielLogin" name="courrielLogin" aria-describedby="emailHelp" placeholder="votre courriel">
				  </div>
				  <div class="form-group">
					<label for="motdepasseLogin">Mot de passe</label>
					<input type="password" class="form-control" id="motdepasseLogin" name="motdepasseLogin" placeholder="Mot de passe">
				  </div>
				  <button type="submit" id="btnLogin" class="btn btn-primary">Submit</button><br/><br/>
				  
				 </form>	
				  <p>Pas encore un membre?
				  <button type="button" class="navbtn" id="inscriptionBtn"/><span style="color:blue">Inscription</span></button></p>
				  </fieldset>				
			</div>
			
			<div class="hide" id="inscription"> 
				<form id="inscriptionF">
					<fieldset>
					<legend>INSCRIPTION</legend>
				  <div class="form-group">
					<label for="nomInscri">Nom</label>
					<input type="text" class="form-control" id="nomInscri" name="nomInscri" aria-describedby="emailHelp" placeholder="votre nom">
				  </div>
				  <div class="form-group">
					<label for="prenomInscri">Prénom</label>
					<input type="text" class="form-control" id="prenomInscri" name="prenomInscri" placeholder="votre prénom">
				  </div>
				  <div class="form-group">
					<label for="courrielInscri">Courriel</label>
					<input type="email" class="form-control" id="courrielInscri" name="courrielInscri" aria-describedby="emailHelp" placeholder="votre courriel">
				  </div>
				  <div class="form-group">
					<label for="adresseInscri">Adresse</label>
					<input type="text" class="form-control" id="adresseInscri" name="adresseInscri" aria-describedby="emailHelp" placeholder="votre adresse">
				  </div>
				  <div class="form-group">
					<label for="motdepasseInscri">Mot de passe</label>
					<input type="password" class="form-control" id="motdepasseInscri" name="motdepasseInscri" placeholder="Mot de passe">
				  </div>
				  <div class="form-group">
					<label for="motdepasseConfirm">Confirmation de mot de passe</label>
					<input type="password" class="form-control" id="motdepasseConfirm" name="motdepasseConfirm" placeholder="Mot de passe">
				  </div>
				  <button type="submit" id="btnNouveauUser" class="btn btn-primary">Submit</button>
				  </fieldset>
				</form>	
			</div>
			
			<div class="hide" id="nouveauFilm"> 
				<form id="nouveauF">
					<fieldset>
							<legend id="titre_nouveau" class='show'>NOUVEAU FILM</legend>
							<legend id="titre_modification" class='hide'>MODIFIER FILM</legend>
				  <div class="form-group">
					<label for="titre">Titre</label>
					<input type="text" class="form-control" id="titre" name="titre" value="" aria-describedby="emailHelp" placeholder="titre du film">
				  </div>
				  <div class="form-group">
					<label for="realisateur">Réalisateur</label>
					<input type="text" class="form-control" id="realisateur" name="realisateur" value="" placeholder="réalisateur du film">
				  </div>
				  <div class="form-group">
					<label for="categorie">Catégorie</label><br/>
					<select id="categorie" name="categorie">
						  <!--option value="1">Action</option>
						  <option value="2">Drame</option>
						  <option value="3">Comédie</option>
						  <option value="4">Horreur</option>
						  <option value="5">Science Fiction</option-->
					</select><br/><br/>
					<p>Trouve pas une bonne categorie?<a href='#' class='nouveauCategorie' id='nouveauCategrie'><span style='color:blue'>ajouter une nouvelle catégorie</span></a></p>
				  </div>
				  <div class="form-group">
					<label for="duree">Durée</label>
					<input type="text" class="form-control" id="duree" name="duree" value="" placeholder="durée du film">
				  </div>
				  <div class="form-group">
					<label for="prix">Prix</label>
					<input type="text" class="form-control" id="prix" name="prix" value="" placeholder="prix du film">
				  </div>
				  <div class="form-group">
					<label for="pochette">Pochette</label>
					<input type="file" class="form-control" id="pochette" name="pochette" value="" placeholder="téléverser une pochette">
				  </div>
				  <input type="hidden" id="idd" name="idd" value="0">
				  <button type="submit" id="btnNouveauFilm" class="btn btn-primary">Submit</button>
				  <button type="button" id="btnCancelFilm" class="btn btn-primary">Annulé</button>
				  </fieldset>
				</form>	
			</div>
			
			<div id="gestionFilm" class="col-md-10 hide">
				<div class="col-md-10 center">
					<a id="" class="btn mini blue-stripe btnNouveauFilm" href="#">Nouveau Film</a>
					<table class="table table-striped table-hover table-users">
						<thead>
							<tr>   					
								<th>ID</th>
								<th>Titre</th>
								<th>Réalisateur</th>
								<th>Catégorie</th>
								<th>Durée</th>
								<th>Prix</th>
								<th>Pochette</th>
								<th></th>
								<th></th>
							</tr>
						</thead>
						<tbody id="tb"></tbody>
					</table>
				</div>
			</div>		
			
	        <footer id="footer" class="copyright  col-md-12">
			      <p>© 2018 - Maisonneuve</p>
	        </footer> 
		</div>		
	</body>
		<script type="text/javascript">
        $(function(){
		
		    /////////////////// read all films and display  //////////////////////////////		
			afficherFilm('gestionFilm/lire.php', '0');
			setCategorie();
			
			//////////////// Set category data  ///////////////////////////////////////
			function setCategorie() {
				$.getJSON('gestionFilm/lireCategorie.php', function(data) {
					$("#categorieMenu").empty();
					$("select#categorie").empty();
					$("#categorieMenu").append("<li id='item0' class='active'><a href='#'  class='menuItem' id='0'>Tous les films</a></li>");
					$.each(data, function(index, item) {
						$("#categorieMenu").append("<li id='item" + (index+1) + "' class=''><a href='#' class='menuItem' id='" + (index+1) + "'>" + item + "</a></li>");
						$("select#categorie").append("<option value='" + index + "'>"  + item +  "</option>");
						//$('<option>').val(index).text(item).appendTo('#select#categorie');
					});
				});	
			}

			////////////// choose category ////////////////////////////////////////////////
			$(document).on("click", "a.menuItem", function() {
					var n = "item" + this.id.toString();
					$("li").removeClass("active");
					$("li#" + n).addClass("active");
					alert(this.id);
					if (this.id == 0) {
						afficherFilm('gestionFilm/lire.php', '0');
					} else {
						afficherFilm('gestionFilm/lireFilmParCategorie.php', this.id);
					}
			});			
			
			
			///////////// click connexion button and display login page ///////////////////
			$('#connexionBtn').on("click", function(){
				$('#menu').addClass("hide").removeClass("show");
				$('#main').addClass("hide").removeClass("show");
				$('#login').addClass("show").removeClass("hide");
				$('#inscription').addClass("hide").removeClass("show");
				$('#nouveauFilm').addClass("hide").removeClass("show");
			})
			
			/////////// login /////////////////////////////
			 $("#loginF").validate({
				// Specify validation rules
				rules: {
				  courrielLogin: {
				    required: true,
					email: true
					},
				  motdepasseLogin: {
				    required: true,
					minlength:6
					}
				},
				// Specify validation error messages
				messages: {
				  courrielLogin: {
					required: "Entrer votre courriel!",
					email: "Entrer un courriel valide!!"
				   },
				  motdepasseLogin: {
					required: "Entrer mot de passe!",
					minlength: "Mot de passe doit contenir au moins 6 lettres!"
				   }
				},
				// submit handler
				submitHandler: function(form) {   
					$.ajax({
						url: "gestionUtilisateur/authentification.php",
						type: 'POST',
						data: $(form).serialize(),
						success: function (data) {
							var result = JSON.parse(data);	

							if(result[0] == true) {
								//alert("OK");
								$user=result[1];
								$role=result[2];
								$("#gestion").addClass("show").removeClass("hide");
								$("#gestionFilm").addClass("show").removeClass("hide");
								$("#login").addClass("hide").removeClass("show");
								updateGestionFilm();												
							}else{
								alert("No");
							}
						},
					});						
				}
			});
			
			//////////// Modifier Film  ///////////////////////////////////////////////////
			$(document).on("click", "a.modifier", function() {
				alert(this.id);
				var idd = this.id.toString();
				$.getJSON("gestionFilm/rechercheParId.php", { id: this.id }, function(data) {
					$("#titre_nouveau").addClass("hide").removeClass("show");
					$("#titre_modification").addClass("show").removeClass("hide");
					$("#nouveauFilm").addClass("show").removeClass("hide");
					$("#gestionFilm").addClass("hide").removeClass("show");

					$("#titre").attr("value", data[1]);
					$("#realisateur").attr("value", data[2]);
					$("#categorie").val(data[3].toString());
					$("#duree").attr("value", data[4]);
					$("#prix").attr("value", data[5]);
					$("#idd").attr("value", idd);
				});			
			});
			
			//////////// Delete Film  ///////////////////////////////////////////////////
			$(document).on("click", "a.supprimer", function() {
				$.getJSON("gestionFilm/supprimerFilm.php", { id: this.id }, function(data) {
					alert(data);
					updateGestionFilm();
					$("#gestion").addClass("show").removeClass("hide");		
					$("#gestionFilm").addClass("show").removeClass("hide");			
				});			
			});
			
			//////////// Select "Gestion de Film"  //////////////////////////////////////
			$(document).on("click", "a.menuGestionFilm", function() {
				alert("gestion film");
				$("#liGestionFilm").addClass("active");
				$("#liGestionMembre").removeClass("active");
				$("#gestionFilm").addClass("show").removeClass("hide");		
			});
			
			//////////// Select "Gestion de Membre"  //////////////////////////////////////
			$(document).on("click", "a.menuGestionMembre", function() {
				alert("gestion membre");
				$("#liGestionFilm").removeClass("active");
				$("#liGestionMembre").addClass("active");
				$("#gestionFilm").addClass("hide").removeClass("show");		
			});

			//////////// Cancel New Film or Modification Film ///////////////////////////////////////////////////
			$("#btnCancelFilm").on("click", function() {
				//alert(this.id);
				$("input:text").val("");				
				$("input:file").val("");
				$("#gestionFilm").addClass("show").removeClass("hide");	
				$("#nouveauFilm").addClass("hide").removeClass("show");									
			});
						
			//////////// New Film  ///////////////////////////////////////////////////
			$(document).on("click", "a.btnNouveauFilm", function() {
				//alert(this.id);
				$("#titre_modification").addClass("hide").removeClass("show");
				$("#titre_nouveau").addClass("show").removeClass("hide");
				$("#gestionFilm").addClass("hide").removeClass("show");	
				$("#nouveauFilm").addClass("show").removeClass("hide");				
			});
			
			
			/////////// click inscription button and display inscription page ///////////////
			$('#inscriptionBtn').on("click", function(){
				$('#menu').addClass("hide").removeClass("show");
				$('#main').addClass("hide").removeClass("show");
				$('#login').addClass("hide").removeClass("show");
				$('#inscription').addClass("show").removeClass("hide");
				$('#nouveauFilm').addClass("hide").removeClass("show");
			})

			/////////// create new film and save in database /////////////////////////////
			 $("#nouveauF").validate({
				// Specify validation rules
				rules: {
				  titre: "required",
				  realisateur: "required",
				  categorie: "required",
				  duree: "required",
				  prix: "required",
				  pochette: "required",
				},
				// Specify validation error messages
				messages: {
				  titre: "Entrer le titre du film!",
				  realisateur: "Entrer le realisateur du film!",
				  categorie: "Choisir la categorie du film!",
				  duree: "Entrer la duree du film!",
				  prix: "Entrer le prix du film!",
				  pochette: "Choisir la pochette du film!",
				},
				// submit handler				
				submitHandler: function(form) {   
					if ($("#idd").val()=="0") {	
						var url = "gestionFilm/ajouterFilm.php";	
					} else {	
						var url = "gestionFilm/miseajourFilm.php";	
					}		
					alert(url);	
					var formData = new FormData(form);	
					$.ajax({	
						url: url,	
						type: 'POST',	
						data: formData,	
						success: function (data) {	
							updateGestionFilm();							
							$("#gestion").addClass("show").removeClass("hide");			
							$("#gestionFilm").addClass("show").removeClass("hide");									
							$("#nouveauFilm").addClass("hide").removeClass("show");		
							$("input:text").val("");	
							$("input:file").val("");	
							$("#idd").attr("value", "0");	
						},	
						cache: false,	
						contentType: false,	
						processData: false	
					});								
				}	
			});
			
			
			/////////// create new user and save in database /////////////////////////////
			 $("#inscriptionF").validate({
				// Specify validation rules
				rules: {
				  nomInscri: "required",
				  prenomInscri: "required",
				  courrielInscri: {
				    required: true,
					email: true
					},
				  adresseInscri: "required",
				  motdepasseInscri: {
				    required: true,
					minlength:6
					},
				  motdepasseConfirm: {
				    required: true,
					minlength:6,
					equalTo: "#motdepasseInscri"
					}
				},
				// Specify validation error messages
				messages: {
				  nomInscri: "Entrer le titre du film!",
				  prenomInscri: "Entrer le realisateur du film!",
				  courrielInscri: "Entrer un courriel valide!",
				  adresseInscri: "Entrer l'adresse!",
				  motdepasseInscri: {
					required: "Entrer un mot de passe!",
					minlength: "Mot de passe doit contenir au moins 6 lettres!"
				   },
				  motdepasseConfirm: {
					required: "Entrer mot de passe!",
					minlength: "Mot de passe doit contenir au moins 6 lettres!",
					equalTo: "Mots de paase n'accordent pas!"
				   }
				},
				// submit handler
				submitHandler: function(form) {  
					//alert("aaa");	
					$.ajax({	
						url: "gestionUtilisateur/ajouterUser.php",	
						type: 'POST',	
						data: $(form).serialize(),	
						success: function (data) {	
							alert(data)	
						},	
					});							
				}
			});
			
			//////////// film form generator /////////////////
			function updateGestionFilm() {
			    $('#tb').empty();
				$.getJSON('gestionFilm/lire.php', function(data) {
					$.each(data, function (index) {							
						$('#tb').append("<tr ><td>" + (index+1) + "</td><td>" + data[index][1] + "</td><td>" + data[index][2] + 						
						           "</td><td>" + data[index][3] + "</td><td>" + data[index][4] + "</td><td>" + data[index][5] + 						
								   "</td><td><img src='images/" + data[index][6] + 						
								   "' width=30 height=40></td><td><a id='" + data[index][0] + 						
								   "' class='btn mini blue-stripe modifier' href='#'>Modifier</a></td><td><a id='" + data[index][0] + 						
								   "' class='btn mini blue-stripe supprimer' href='#'>Suppimer</a></td></tr>");										
					})						
				});									
			}
			
			//////////// affichage des cartes du film  ///////////////////////////////////
			function afficherFilm(url, nb) {
				$('#films').empty();
				$.getJSON(url, {id: nb}, function(data) {
					$.each(data, function (index) {
						var view = {
							titre: data[index][1],
							realisateur: data[index][2],
							prix: data[index][5],
							pochette: data[index][6]
						};
						var template = document.getElementById('templateCard').innerHTML;
						var output = Mustache.render(template, view);
						$('#films').append(output);				
					})
				});	
			}			
	    });
		 
	</script>
</html>